---
const { versions } = Astro.props;

function parseVersion(v) {
  return v.split(".").map(n => parseInt(n, 10) || 0);
}

function compareVersions(a, b) {
  const av = parseVersion(a);
  const bv = parseVersion(b);
  for (let i = 0; i < Math.max(av.length, bv.length); i++) {
    const diff = (av[i] || 0) - (bv[i] || 0);
    if (diff !== 0) return diff;
  }
  return 0;
}

const allLabels = versions.flatMap(v => [
  ...(v.links?.map(l => l.label) || []),
  ...(v.betalinks?.map(l => l.label) || [])
]);

const latestLabel = allLabels.sort(compareVersions).pop();

function isLatestVersion({ links = [], betalinks = [] }) {
  return (
    links.some(l => l.label === latestLabel) ||
    betalinks.some(l => l.label === latestLabel)
  );
}

const reversedVersions = versions.reverse();
---

<div class="versions-wrapper versions-tab d-flex flex-column flex-md-row border border-2 rounded-3 shadow-sm">
  <!-- Sidebar -->
  <aside class="versions-sidebar col-md-3 p-3 d-md-block">
    <ul class="nav nav-pills flex-column gap-2">
      {reversedVersions.map(({ id, title, links, betalinks }, index) => (
        <li class="nav-item">
          <button
            class={`nav-link w-100 text-start ${index === 0 ? "active" : ""}`}
            id={`${id}-tab`}
            data-bs-toggle="tab"
            data-bs-target={`#${id}-pane`}
            type="button"
            role="tab"
            aria-controls={`${id}-pane`}
            aria-selected={index === 0}
          >
            {title}
            {isLatestVersion({ links, betalinks }) && (
              <span class="badge bg-success ms-2">Latest</span>
            )}
          </button>
        </li>
      ))}
    </ul>
  </aside>

  <!-- Content -->
  <section class="flex-grow-1 p-4">
    <div class="tab-content">
      {reversedVersions.map(({ id, title, dates, description, betalinks, links }, index) => (
        <div
          class={`tab-pane fade ${index === 0 ? "show active" : ""}`}
          id={`${id}-pane`}
          role="tabpanel"
          aria-labelledby={`${id}-tab`}
        >
          <h2 class="fw-bold">{title}</h2>

          {dates && <p class="text-muted">{dates}</p>}

          {betalinks && (
            <div class="d-flex flex-wrap gap-3 my-4">
              {betalinks.map(({ label, url }) => (
                <a href={url} class="btn btn-outline-warning">
                  {label}
                  {label === latestLabel && (
                    <span class="badge bg-success ms-2">Latest</span>
                  )}
                </a>
              ))}
            </div>
          )}

          {links && (
            <div class="d-flex flex-wrap gap-3 my-4">
              {links.map(({ label, url }) => (
                <a href={url} class="btn btn-outline-primary">
                  {label}
                  {label === latestLabel && (
                    <span class="badge bg-success ms-2">Latest</span>
                  )}
                </a>
              ))}
            </div>
          )}

          {description && (
            <p class="my-4" set:html={description} />
          )}
        </div>
      ))}
    </div>
  </section>
</div>